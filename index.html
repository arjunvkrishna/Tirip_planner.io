<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Planner</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #e9ecef;
            --border-color: #ddd;
            --button-primary: linear-gradient(45deg, #007bff, #0056b3);
            --button-secondary: #6c757d;
            --button-secondary-hover: #5a6268;
            --error-bg: rgba(220, 53, 69, 0.1);
            --total-cost-color: #0056b3;
            --toggle-bg: #ccc;
            --toggle-thumb: #f1f1f1;
            --toggle-checked-bg: #2196F3;
        }

        .dark-theme {
            --bg-color: #2c3e50;
            --text-color: #f1f1f1;
            --card-bg: #34495e;
            --border-color: #444;
            --button-primary: linear-gradient(45deg, #1abc9c, #16a085);
            --button-secondary: #7f8c8d;
            --button-secondary-hover: #636e72;
            --error-bg: rgba(231, 76, 60, 0.2);
            --total-cost-color: #1abc9c;
            --toggle-bg: #555;
            --toggle-thumb: #f1f1f1;
            --toggle-checked-bg: #1abc9c;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        #sidebar {
            width: 380px;
            background: var(--bg-color);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        #map {
            flex: 1;
            background-color: var(--card-bg);
        }
        h1 {
            font-size: 24px;
            margin-top: 0;
            text-align: center;
        }
        h3 {
            margin-bottom: 10px;
        }
       .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
        }
        input[type="text"], input[type="time"], input[type="number"], select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 15px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        input[type="checkbox"] {
            width: auto;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        input:disabled, select:disabled {
            background-color: var(--card-bg);
            opacity: 0.7;
            cursor: not-allowed;
        }
        button {
            width: 100%;
            padding: 10px;
            background: var(--button-primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        button:hover {
            opacity: 0.9;
        }
        #add-stop-btn {
            background: var(--button-secondary);
            margin-top: 10px;
        }
        #add-stop-btn:hover {
            background: var(--button-secondary-hover);
        }
        #results {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        #results h2 {
            margin-top: 0;
            text-align: center;
        }
        #results p {
            margin: 8px 0;
            font-size: 15px;
            background-color: var(--card-bg);
            padding: 10px;
            border-radius: 6px;
        }
       .time-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
       .time-option {
            flex: 1;
        }
       .error {
            color: #dc3545;
            font-weight: bold;
            margin-top: 15px;
            text-align: center;
            padding: 10px;
            background-color: var(--error-bg);
            border-radius: 6px;
        }
       .loader {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .total-cost {
            font-weight: bold;
            color: var(--total-cost-color);
            font-size: 16px !important;
        }
        .weather-info {
            font-weight: 600;
        }
        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: 10px;
            gap: 10px;
        }
        .theme-toggle label {
            margin: 0;
            cursor: pointer;
        }
        .vehicle-profile {
            border: 1px solid var(--border-color);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: var(--card-bg);
        }
        .vehicle-profile h3 {
            margin-top: 0;
        }
        .add-vehicle-option {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        /* Styling for the new location button and its container */
        .input-with-button {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .input-with-button input {
            flex-grow: 1;
        }
        .location-btn {
            width: auto !important;
            padding: 8px 12px !important;
            font-size: 16px !important;
            margin-bottom: 0 !important;
            background: var(--button-secondary) !important;
        }
        .location-btn:hover {
            background: var(--button-secondary-hover) !important;
        }
        /* Toggle Switch Styling */
       .switch-label {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
            border-radius: 34px;
            background-color: var(--toggle-bg);
            cursor: pointer;
            transition: background-color 0.4s;
        }
       .switch-label::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--toggle-thumb);
            top: 2px;
            left: 2px;
            transition: transform 0.4s;
        }
       .theme-checkbox:checked + .switch-label {
            background-color: var(--toggle-checked-bg);
        }
       .theme-checkbox:checked + .switch-label::after {
            transform: translateX(22px);
        }
       .theme-checkbox {
            display: none;
        }

    </style>
</head>
<body>

    <div id="sidebar">
        <div class="theme-toggle">
            <label>Dark Mode</label>
            <input type="checkbox" id="theme-switch" class="theme-checkbox">
            <label for="theme-switch" class="switch-label"></label>
        </div>
        <h1>Trip Planner üöó</h1>
        
        <div class="input-group">
            <label for="origin">Origin</label>
            <div class="input-with-button">
                <input type="text" id="origin" placeholder="e.g., Ernakulam">
                <button id="get-location-btn" type="button" class="location-btn" title="Use my current location">üìç</button>
            </div>
        </div>

        <div id="stops-container">
        </div>
        <button id="add-stop-btn" type="button">Add Stop</button>

        <div class="input-group" style="margin-top: 15px;">
            <label for="destination">Destination</label>
            <input type="text" id="destination" placeholder="e.g., Munnar">
        </div>

        <div class="time-toggle">
            <div class="time-option">
                <label for="start-time">Start Time</label>
                <input type="time" id="start-time">
            </div>
            <div class="time-option">
                <label for="end-time">Arrival Time</label>
                <input type="time" id="end-time">
            </div>
        </div>
        
        <hr>
        
        <div class="vehicle-profile">
            <h3>Vehicle 1 Details</h3>
            <div class="input-group">
                <label for="mileage1">Vehicle Mileage (km/L)</label>
                <input type="number" id="mileage1" placeholder="e.g., 15" value="15">
            </div>
            
            <div class="input-group">
                <label for="fuel-type1">Fuel Type</label>
                <select id="fuel-type1">
                    <option value="petrol">Petrol</option>
                    <option value="diesel">Diesel</option>
                </select>
                <p id="current-fuel-price-display1" style="margin-top: 10px; font-weight: bold;"></p>
            </div>
        </div>
        
        <div class="add-vehicle-option">
            <label for="add-vehicle2-checkbox" style="font-weight: normal;">Add Second Vehicle</label>
            <input type="checkbox" id="add-vehicle2-checkbox">
        </div>

        <div id="vehicle2-profile-container" class="vehicle-profile" style="display: none;">
            <h3>Vehicle 2 Details</h3>
            <div class="input-group">
                <label for="mileage2">Vehicle Mileage (km/L)</label>
                <input type="number" id="mileage2" placeholder="e.g., 20">
            </div>
            
            <div class="input-group">
                <label for="fuel-type2">Fuel Type</label>
                <select id="fuel-type2">
                    <option value="petrol">Petrol</option>
                    <option value="diesel">Diesel</option>
                </select>
                <p id="current-fuel-price-display2" style="margin-top: 10px; font-weight: bold;"></p>
            </div>
        </div>
        
        <hr>
        <h3>Additional Expenses</h3>
        <div class="input-group">
            <label for="hotel-cost">Hotel Cost</label>
            <input type="number" id="hotel-cost" placeholder="e.g., 2500" value="0">
        </div>
        <div class="input-group">
            <label for="food-cost">Food Cost (per day)</label>
            <input type="number" id="food-cost" placeholder="e.g., 1000" value="0">
        </div>
        <div class="input-group">
            <label for="misc-cost">Miscellaneous (per day)</label>
            <input type="number" id="misc-cost" placeholder="e.g., 500" value="0">
        </div>
        <hr>

        <div class="input-group">
            <label for="round-trip" style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
                <input type="checkbox" id="round-trip">
                <span>Calculate Round Trip</span>
            </label>
        </div>

        <button id="calculate-trip">Calculate Trip</button>
        <button id="export-pdf-btn">Export as PDF</button>

        <div class="loader" id="loader">
            <p>Calculating...</p>
        </div>

        <div id="results">
            <h2>Trip Details</h2>
            <p id="origin-weather" class="weather-info"></p>
            <p id="destination-weather" class="weather-info"></p>
            <p id="total-distance"></p>
            <p id="total-duration"></p>
            <p id="time-calculation-result"></p>
            
            <div id="vehicle1-results" class="vehicle-results-section">
                <h3>Vehicle 1 Cost Breakdown</h3>
                <p id="fuel-cost1"></p>
                <p id="round-trip-distance1" style="display: none;"></p>
                <p id="round-trip-fuel-cost1" style="display: none;"></p>
                <p id="total-trip-cost1" class="total-cost"></p>
            </div>

            <div id="vehicle2-results" class="vehicle-results-section" style="display: none;">
                <h3>Vehicle 2 Cost Breakdown</h3>
                <p id="fuel-cost2"></p>
                <p id="round-trip-distance2" style="display: none;"></p>
                <p id="round-trip-fuel-cost2" style="display: none;"></p>
                <p id="total-trip-cost2" class="total-cost"></p>
            </div>

            <p id="error-message" class="error"></p>
        </div>
    </div>
    <div id="map"></div>

    <script>
        // --- API KEY & MODEL ---
        const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY_HERE"; // IMPORTANT: Replace with your actual key
        const GEMINI_MODEL = "gemini-1.5-flash"; // Updated model

        // Initialize Leaflet map
        const map = L.map('map').setView([8.5241, 76.9366], 12); // Default center (Thiruvananthapuram)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map); 

        // Get DOM elements
        const originInput = document.getElementById('origin');
        const destinationInput = document.getElementById('destination');
        const stopsContainer = document.getElementById('stops-container');
        const addStopBtn = document.getElementById('add-stop-btn');
        const calculateBtn = document.getElementById('calculate-trip');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const getLocationBtn = document.getElementById('get-location-btn'); // NEW: Location button
        const resultsDiv = document.getElementById('results');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const startTimeInput = document.getElementById('start-time');
        const endTimeInput = document.getElementById('end-time');
        
        // Vehicle 1 elements
        const mileageInput1 = document.getElementById('mileage1');
        const fuelTypeDropdown1 = document.getElementById('fuel-type1');
        const fuelPriceDisplay1 = document.getElementById('current-fuel-price-display1');
        
        // Vehicle 2 elements
        const addVehicle2Checkbox = document.getElementById('add-vehicle2-checkbox');
        const vehicle2ProfileContainer = document.getElementById('vehicle2-profile-container');
        const mileageInput2 = document.getElementById('mileage2');
        const fuelTypeDropdown2 = document.getElementById('fuel-type2');
        const fuelPriceDisplay2 = document.getElementById('current-fuel-price-display2');

        const themeSwitch = document.getElementById('theme-switch');

        let stopCount = 0;
        let fuelPrices = {
            petrol: null,
            diesel: null
        };

        // --- Event Listeners ---
        window.addEventListener('load', () => {
            fetchAndDisplayFuelPrices();
            applySavedTheme();
        });

        startTimeInput.addEventListener('input', () => {
            if (startTimeInput.value) {
                endTimeInput.value = '';
                endTimeInput.disabled = true;
            } else {
                endTimeInput.disabled = false;
            }
        });

        endTimeInput.addEventListener('input', () => {
            if (endTimeInput.value) {
                startTimeInput.value = '';
                startTimeInput.disabled = true;
            } else {
                startTimeInput.disabled = false;
            }
        });

        addStopBtn.addEventListener('click', () => {
            stopCount++;
            const stopDiv = document.createElement('div');
            stopDiv.className = 'input-group';
            stopDiv.innerHTML = `
                <label for="stop-${stopCount}">Stop ${stopCount}</label>
                <input type="text" id="stop-${stopCount}" class="stop-input" placeholder="Add an intermediate stop">
            `;
            stopsContainer.appendChild(stopDiv);
        });
        
        fuelTypeDropdown1.addEventListener('change', () => updateDisplayedFuelPrice(1));
        fuelTypeDropdown2.addEventListener('change', () => updateDisplayedFuelPrice(2));

        calculateBtn.addEventListener('click', calculateTrip);
        exportPdfBtn.addEventListener('click', exportResultsToPdf);
        themeSwitch.addEventListener('change', toggleTheme);
        addVehicle2Checkbox.addEventListener('change', toggleVehicle2Display);
        getLocationBtn.addEventListener('click', getUserLocation); // NEW: Event listener for location button

        // --- NEW: Location Functions ---

        /**
         * Initiates the process of getting the user's current location.
         */
        function getUserLocation() {
            if (navigator.geolocation) {
                originInput.placeholder = 'Fetching your location...';
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        reverseGeocode(lat, lon);
                    },
                    () => {
                        showError("Unable to retrieve location. Please grant permission or enter it manually.");
                        originInput.placeholder = 'e.g., Ernakulam';
                    }
                );
            } else {
                showError("Geolocation is not supported by your browser.");
            }
        }

        /**
         * Converts latitude and longitude into a human-readable address using Nominatim API.
         * @param {number} lat The latitude.
         * @param {number} lon The longitude.
         */
        async function reverseGeocode(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Reverse geocoding request failed.');
                const data = await response.json();
                
                const address = data.address;
                // Construct a readable address. Prioritize city, then town, then village.
                const locationName = address.city || address.town || address.village || address.suburb || 'Current Location';
                
                originInput.value = locationName;

            } catch (error) {
                console.error("Reverse geocoding error:", error);
                showError("Could not find address for your location. Please enter it manually.");
                originInput.placeholder = 'e.g., Ernakulam';
            }
        }

        // --- Theme Functions ---
        function applySavedTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                themeSwitch.checked = true;
            }
        }

        function toggleTheme() {
            if (themeSwitch.checked) {
                document.body.classList.add('dark-theme');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-theme');
                localStorage.setItem('theme', 'light');
            }
        }

        /**
         * Toggles the display of the second vehicle's details section.
         */
        function toggleVehicle2Display() {
            if (addVehicle2Checkbox.checked) {
                vehicle2ProfileContainer.style.display = 'block';
                document.getElementById('vehicle2-results').style.display = 'block';
            } else {
                vehicle2ProfileContainer.style.display = 'none';
                document.getElementById('vehicle2-results').style.display = 'none';
                // Clear inputs for the second vehicle to prevent calculations
                mileageInput2.value = '';
                fuelTypeDropdown2.value = 'petrol';
            }
        }

        /**
         * Fetches current fuel prices for Petrol and Diesel in Thiruvananthapuram using the Gemini API.
         * The prices are stored in a global object and the display is updated.
         */
        async function fetchAndDisplayFuelPrices() {
            if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
                showError("Please add your Gemini API key to the script.");
                return;
            }

            const prompt = `Provide the current fuel prices for petrol and diesel in Thiruvananthapuram, Kerala, India today. The response should be a JSON object with the prices in Indian Rupees (‚Çπ) per liter.`;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };
            
            try {
                fuelPriceDisplay1.textContent = "Fetching...";
                fuelPriceDisplay2.textContent = "Fetching...";
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!text) {
                    throw new Error("Received an empty response from the API.");
                }
                
                // Clean the response text by removing markdown backticks and 'json' label
                const cleanedText = text.replace(/```json\n?|```/g, '').trim();
                const prices = JSON.parse(cleanedText);
                
                if (prices.petrol_price && prices.diesel_price) {
                    fuelPrices.petrol = prices.petrol_price;
                    fuelPrices.diesel = prices.diesel_price;
                    updateDisplayedFuelPrice(1);
                    if (addVehicle2Checkbox.checked) {
                        updateDisplayedFuelPrice(2);
                    }
                } else {
                    throw new Error("Could not parse fuel prices from the API response.");
                }
            } catch (error) {
                console.error('Gemini API error:', error);
                const errorMsg = "Error fetching prices. Please try again later.";
                fuelPriceDisplay1.textContent = errorMsg;
                fuelPriceDisplay2.textContent = errorMsg;
            }
        }

        /**
         * Updates the displayed fuel price for a specific vehicle.
         * @param {number} vehicleId - The ID of the vehicle (1 or 2).
         */
        function updateDisplayedFuelPrice(vehicleId) {
            const fuelTypeDropdown = document.getElementById(`fuel-type${vehicleId}`);
            const fuelPriceDisplay = document.getElementById(`current-fuel-price-display${vehicleId}`);
            const selectedFuelType = fuelTypeDropdown.value;
            const price = fuelPrices[selectedFuelType];
            if (price !== null) {
                fuelPriceDisplay.textContent = `Current Price in Thiruvananthapuram: ‚Çπ${price.toFixed(2)} per liter`;
            } else {
                fuelPriceDisplay.textContent = "Price not available.";
            }
        }
        
        /**
         * Main function to calculate the trip details by calling the Gemini API.
         */
        async function calculateTrip() {
            clearResults();

            if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
                showError("Please add your Gemini API key to the script.");
                return;
            }
            
            if (fuelPrices.petrol === null || fuelPrices.diesel === null) {
                showError("Please wait for fuel prices to be fetched before calculating.");
                return;
            }

            loader.style.display = 'block';

            const origin = originInput.value;
            const destination = destinationInput.value;
            const stops = Array.from(document.querySelectorAll('.stop-input'))
                                     .map(input => input.value)
                                     .filter(val => val);

            if (!origin || !destination) {
                showError("Please enter an origin and a destination.");
                return;
            }

            // Append ", Kerala, India" to all location inputs for geographic accuracy.
            const originFull = `${origin}, Kerala, India`;
            const destinationFull = `${destination}, Kerala, India`;
            const stopsFull = stops.map(stop => `${stop}, Kerala, India`);

            let prompt = `Calculate the route for a car trip from "${originFull}" to "${destinationFull}"`;
            if (stopsFull.length > 0) {
                const stopsString = stopsFull.join('" via "');
                prompt = `Calculate the route for a car trip from "${originFull}" via "${stopsString}" to "${destinationFull}"`;
            }
            prompt += `. The trip must be entirely within India. Provide the total distance in kilometers, total duration in minutes, the current weather at the origin, and the current weather at the destination. For weather, include a short description and temperature in Celsius.`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API request failed with status ${response.status}`);
                }

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!text) {
                    throw new Error("Received an empty response from the API.");
                }
                
                const cleanedText = text.replace(/```json\n?|```/g, '').trim();
                const result = JSON.parse(cleanedText);

                const distanceInKm = result.distance_km;
                const durationInSeconds = result.duration_minutes * 60;
                const originWeather = result.origin_weather;
                const destinationWeather = result.destination_weather;

                if (distanceInKm === null || typeof distanceInKm === 'undefined' || durationInSeconds === null || typeof durationInSeconds === 'undefined') {
                    throw new Error("Could not get distance or duration from the API's JSON response.");
                }

                if (!originWeather || !destinationWeather) {
                    throw new Error("Could not get weather information from the API response.");
                }

                displayResults(distanceInKm, durationInSeconds, originWeather, destinationWeather);

            } catch (error) {
                console.error('Gemini API error:', error);
                showError(error.message || "An unexpected error occurred while calculating the trip.");
            } finally {
                loader.style.display = 'none';
            }
        }

        /**
         * Displays the calculated results in the sidebar.
         * @param {number} distanceInKm - Total distance of the trip.
         * @param {number} durationInSeconds - Total duration of the trip.
         * @param {object} originWeather - Weather data for the origin.
         * @param {object} destinationWeather - Weather data for the destination.
         */
        function displayResults(distanceInKm, durationInSeconds, originWeather, destinationWeather) {
            const roundTripCheckbox = document.getElementById('round-trip');
            const isRoundTrip = roundTripCheckbox.checked;

            // Display weather and general trip details
            const originEmoji = getWeatherEmoji(originWeather.description);
            document.getElementById('origin-weather').innerHTML = `Origin Weather: ${originEmoji} ${originWeather.description}, ${originWeather.temperature_celsius.toFixed(1)}¬∞C`;
            
            const destEmoji = getWeatherEmoji(destinationWeather.description);
            document.getElementById('destination-weather').innerHTML = `Destination Weather: ${destEmoji} ${destinationWeather.description}, ${destinationWeather.temperature_celsius.toFixed(1)}¬∞C`;

            document.getElementById('total-distance').textContent = `One-Way Distance: ${distanceInKm.toFixed(2)} km`;
            document.getElementById('total-duration').textContent = `Estimated One-Way Duration: ${formatDuration(durationInSeconds)}`;

            const startTimeValue = startTimeInput.value;
            const endTimeValue = endTimeInput.value;
            const todayStr = new Date().toISOString().slice(0, 10);
            if (startTimeValue) {
                const startDateTime = new Date(`${todayStr}T${startTimeValue}`);
                const arrivalDateTime = new Date(startDateTime.getTime() + durationInSeconds * 1000);
                document.getElementById('time-calculation-result').textContent = `Estimated Arrival: ${arrivalDateTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true })}`;
            } else if (endTimeValue) {
                const endDateTime = new Date(`${todayStr}T${endTimeValue}`);
                const requiredStartDateTime = new Date(endDateTime.getTime() - durationInSeconds * 1000);
                document.getElementById('time-calculation-result').textContent = `Required Start: ${requiredStartDateTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true })}`;
            }

            // Display results for Vehicle 1
            displayVehicleResults(1, distanceInKm, isRoundTrip);
            
            // Display results for Vehicle 2 if the checkbox is checked and mileage is provided
            if (addVehicle2Checkbox.checked) {
                const mileage2 = parseFloat(mileageInput2.value);
                if (!isNaN(mileage2) && mileage2 > 0) {
                    document.getElementById('vehicle2-results').style.display = 'block';
                    displayVehicleResults(2, distanceInKm, isRoundTrip);
                } else {
                    showError("Please enter a valid mileage for the second vehicle.");
                }
            } else {
                document.getElementById('vehicle2-results').style.display = 'none';
            }
        }

        /**
         * Calculates and displays the results for a single vehicle.
         * @param {number} vehicleId - The ID of the vehicle (1 or 2).
         * @param {number} distanceInKm - The total distance of the trip.
         * @param {boolean} isRoundTrip - Whether the trip is a round trip.
         */
        function displayVehicleResults(vehicleId, distanceInKm, isRoundTrip) {
            const mileageInput = document.getElementById(`mileage${vehicleId}`);
            const fuelTypeDropdown = document.getElementById(`fuel-type${vehicleId}`);
            const fuelPrice = fuelPrices[fuelTypeDropdown.value];
            const mileage = parseFloat(mileageInput.value);

            let oneWayCost = 0;
            if (mileage > 0 && fuelPrice > 0) {
                const oneWayFuelNeeded = distanceInKm / mileage;
                oneWayCost = oneWayFuelNeeded * fuelPrice;
            }

            const hotelCost = parseFloat(document.getElementById('hotel-cost').value) || 0;
            const foodCost = parseFloat(document.getElementById('food-cost').value) || 0;
            const miscCost = parseFloat(document.getElementById('misc-cost').value) || 0;

            let totalCost = oneWayCost + hotelCost + foodCost + miscCost;

            document.getElementById(`fuel-cost${vehicleId}`).textContent = `Estimated One-Way Fuel Cost: ‚Çπ${oneWayCost.toFixed(2)}`;
            
            if (isRoundTrip) {
                const roundTripDistance = distanceInKm * 2;
                const roundTripFuelCost = oneWayCost * 2;
                totalCost = roundTripFuelCost + hotelCost + foodCost + miscCost;

                document.getElementById(`round-trip-distance${vehicleId}`).textContent = `Round Trip Distance: ${roundTripDistance.toFixed(2)} km`;
                document.getElementById(`round-trip-fuel-cost${vehicleId}`).textContent = `Round Trip Fuel Cost: ‚Çπ${roundTripFuelCost.toFixed(2)}`;
                
                document.getElementById(`round-trip-distance${vehicleId}`).style.display = 'block';
                document.getElementById(`round-trip-fuel-cost${vehicleId}`).style.display = 'block';
            } else {
                document.getElementById(`round-trip-distance${vehicleId}`).style.display = 'none';
                document.getElementById(`round-trip-fuel-cost${vehicleId}`).style.display = 'none';
            }

            document.getElementById(`total-trip-cost${vehicleId}`).textContent = `Total Estimated Cost: ‚Çπ${totalCost.toFixed(2)}`;
        }

        /**
         * Clears all previous results and error messages from the display.
         */
        function clearResults() {
            const resultElements = [
                'origin-weather', 'destination-weather', 'total-distance', 'total-duration', 
                'time-calculation-result', 'fuel-cost1', 'round-trip-distance1', 'round-trip-fuel-cost1', 
                'total-trip-cost1', 'fuel-cost2', 'round-trip-distance2', 'round-trip-fuel-cost2', 
                'total-trip-cost2'
            ];
            resultElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = '';
            });
            errorMessage.style.display = 'none';
        }

        /**
         * Formats duration in seconds into a "X hours Y minutes" string.
         * @param {number} durationInSeconds - The duration to format.
         * @returns {string} The formatted duration string.
         */
        function formatDuration(durationInSeconds) {
            const hours = Math.floor(durationInSeconds / 3600);
            const minutes = Math.floor((durationInSeconds % 3600) / 60);
            let result = '';
            if (hours > 0) result += `${hours} hour${hours > 1 ? 's' : ''} `;
            if (minutes > 0) result += `${minutes} minute${minutes > 1 ? 's' : ''}`;
            return result.trim();
        }

        /**
         * Displays an error message to the user.
         * @param {string} message - The error message to show.
         */
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            loader.style.display = 'none';
        }

        /**
         * Returns an emoji based on the weather description.
         * @param {string} description - The weather description text.
         * @returns {string} A weather emoji.
         */
        function getWeatherEmoji(description) {
            description = description.toLowerCase();
            if (description.includes('sun') || description.includes('clear')) return '‚òÄÔ∏è';
            if (description.includes('cloud')) return '‚òÅÔ∏è';
            if (description.includes('rain') || description.includes('shower')) return 'üåßÔ∏è';
            if (description.includes('storm')) return '‚õàÔ∏è';
            if (description.includes('mist') || description.includes('fog')) return 'üå´Ô∏è';
            return 'üå°Ô∏è'; // Default
        }

        /**
         * Exports the visible results section to a PDF file.
         */
        function exportResultsToPdf() {
            const resultsToExport = document.getElementById('results');
            if (!resultsToExport.querySelector('#total-distance').textContent) {
                showError('Please calculate a trip before exporting.');
                return;
            }
            const opt = {
                margin: 1,
                filename: 'trip_plan.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().from(resultsToExport).set(opt).save();
        }

    </script>
</body>
</html>