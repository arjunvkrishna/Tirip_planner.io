<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Planner</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #e9ecef;
            --border-color: #ddd;
            --button-primary: linear-gradient(45deg, #007bff, #0056b3);
            --button-secondary: #6c757d;
            --button-secondary-hover: #5a6268;
            --error-bg: rgba(220, 53, 69, 0.1);
            --total-cost-color: #0056b3;
            --toggle-bg: #ccc;
            --toggle-thumb: #f1f1f1;
            --toggle-checked-bg: #2196F3;
            --tab-active-bg: #007bff;
            --tab-inactive-bg: #e9ecef;
            --tab-active-color: #fff;
            --tab-inactive-color: #333;
        }

        .dark-theme {
            --bg-color: #2c3e50;
            --text-color: #f1f1f1;
            --card-bg: #34495e;
            --border-color: #444;
            --button-primary: linear-gradient(45deg, #1abc9c, #16a085);
            --button-secondary: #7f8c8d;
            --button-secondary-hover: #636e72;
            --error-bg: rgba(231, 76, 60, 0.2);
            --total-cost-color: #1abc9c;
            --toggle-bg: #555;
            --toggle-thumb: #f1f1f1;
            --toggle-checked-bg: #1abc9c;
            --tab-active-bg: #1abc9c;
            --tab-inactive-bg: #34495e;
            --tab-active-color: #fff;
            --tab-inactive-color: #f1f1f1;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        #sidebar {
            width: 380px;
            background: var(--bg-color);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        #map {
            flex: 1;
            background-color: var(--card-bg);
        }
        h1 {
            font-size: 24px;
            margin-top: 0;
            text-align: center;
        }
        h3 {
            margin-bottom: 10px;
        }
       .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
        }
        input[type="text"], input[type="time"], input[type="number"], select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 15px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        input[type="checkbox"] {
            width: auto;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        input:disabled, select:disabled {
            background-color: var(--card-bg);
            opacity: 0.7;
            cursor: not-allowed;
        }
        button {
            width: 100%;
            padding: 10px;
            background: var(--button-primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        button:hover {
            opacity: 0.9;
        }
        #add-stop-btn {
            background: var(--button-secondary);
            margin-top: 10px;
        }
        #add-stop-btn:hover {
            background: var(--button-secondary-hover);
        }
        #results {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        #results h2 {
            margin-top: 0;
            text-align: center;
        }
        #results p {
            margin: 8px 0;
            font-size: 15px;
            background-color: var(--card-bg);
            padding: 10px;
            border-radius: 6px;
        }
       .time-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
       .time-option {
            flex: 1;
        }
       .error {
            color: #dc3545;
            font-weight: bold;
            margin-top: 15px;
            text-align: center;
            padding: 10px;
            background-color: var(--error-bg);
            border-radius: 6px;
        }
       .loader {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .total-cost {
            font-weight: bold;
            color: var(--total-cost-color);
            font-size: 16px !important;
        }
        .weather-info {
            font-weight: 600;
        }
        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: 10px;
            gap: 10px;
        }
        .theme-toggle label {
            margin: 0;
            cursor: pointer;
        }
        .vehicle-profile {
            border: 1px solid var(--border-color);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: var(--card-bg);
        }
        .vehicle-profile h3 {
            margin-top: 0;
        }
        .add-vehicle-option {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        /* Toggle Switch Styling */
        .switch-label {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
            border-radius: 34px;
            background-color: var(--toggle-bg);
            cursor: pointer;
            transition: background-color 0.4s;
        }
        .switch-label::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--toggle-thumb);
            top: 2px;
            left: 2px;
            transition: transform 0.4s;
        }
        .theme-checkbox:checked + .switch-label {
            background-color: var(--toggle-checked-bg);
        }
        .theme-checkbox:checked + .switch-label::after {
            transform: translateX(22px);
        }
        .theme-checkbox {
            display: none;
        }
        /* New Styles for Tabs */
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .tab-button {
            flex: 1;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            border: none;
            background-color: var(--tab-inactive-bg);
            color: var(--tab-inactive-color);
            font-weight: 600;
            transition: background-color 0.3s, color 0.3s;
            border-radius: 4px 4px 0 0;
            margin-bottom: 0;
        }
        .tab-button.active {
            background: var(--tab-active-bg);
            color: var(--tab-active-color);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #recent-searches-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .recent-search-item {
            background-color: var(--card-bg);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .recent-search-item:hover {
            background-color: var(--border-color);
        }
        .recent-search-item p {
            margin: 0;
            font-size: 14px;
        }
        .recent-search-item .route {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .recent-search-item .stops {
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.8;
        }

    </style>
</head>
<body>

    <div id="sidebar">
        <div class="theme-toggle">
            <label>Dark Mode</label>
            <input type="checkbox" id="theme-switch" class="theme-checkbox">
            <label for="theme-switch" class="switch-label"></label>
        </div>
        <h1>Trip Planner üöó</h1>

        <!-- Tabs Navigation -->
        <div class="tabs">
            <button class="tab-button active" onclick="openTab('planner')">Planner</button>
            <button class="tab-button" onclick="openTab('recent')">Recent Searches</button>
        </div>

        <!-- Planner Tab Content -->
        <div id="planner" class="tab-content active">
            <div class="input-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <label for="origin" style="margin-bottom: 0;">Origin</label>
                    <button id="use-current-location-btn" type="button" style="width: auto; padding: 5px 10px; font-size: 12px; font-weight: 500; background: var(--button-secondary); margin: 0;">üìç Use My Location</button>
                </div>
                <input type="text" id="origin" placeholder="e.g., Ernakulam">
            </div>

            <div id="stops-container"></div>
            <button id="add-stop-btn" type="button">Add Stop</button>

            <div class="input-group" style="margin-top: 15px;">
                <label for="destination">Destination</label>
                <input type="text" id="destination" placeholder="e.g., Munnar">
            </div>

            <div class="time-toggle">
                <div class="time-option">
                    <label for="start-time">Start Time</label>
                    <input type="time" id="start-time">
                </div>
                <div class="time-option">
                    <label for="end-time">Arrival Time</label>
                    <input type="time" id="end-time">
                </div>
            </div>
            
            <hr>
            
            <div class="vehicle-profile">
                <h3>Vehicle 1 Details</h3>
                <div class="input-group">
                    <label for="mileage1">Vehicle Mileage (km/L)</label>
                    <input type="number" id="mileage1" placeholder="e.g., 15" value="15">
                </div>
                <div class="input-group">
                    <label for="fuel-type1">Fuel Type</label>
                    <select id="fuel-type1">
                        <option value="petrol">Petrol</option>
                        <option value="diesel">Diesel</option>
                    </select>
                    <p id="current-fuel-price-display1" style="margin-top: 10px; font-weight: bold;"></p>
                </div>
            </div>
            
            <div class="add-vehicle-option">
                <label for="add-vehicle2-checkbox" style="font-weight: normal;">Add Second Vehicle</label>
                <input type="checkbox" id="add-vehicle2-checkbox">
            </div>

            <div id="vehicle2-profile-container" class="vehicle-profile" style="display: none;">
                <h3>Vehicle 2 Details</h3>
                <div class="input-group">
                    <label for="mileage2">Vehicle Mileage (km/L)</label>
                    <input type="number" id="mileage2" placeholder="e.g., 20">
                </div>
                <div class="input-group">
                    <label for="fuel-type2">Fuel Type</label>
                    <select id="fuel-type2">
                        <option value="petrol">Petrol</option>
                        <option value="diesel">Diesel</option>
                    </select>
                    <p id="current-fuel-price-display2" style="margin-top: 10px; font-weight: bold;"></p>
                </div>
            </div>
            
            <hr>
            <h3>Additional Expenses</h3>
            <div class="input-group">
                <label for="hotel-cost">Hotel Cost</label>
                <input type="number" id="hotel-cost" placeholder="e.g., 2500" value="0">
            </div>
            <div class="input-group">
                <label for="food-cost">Food Cost (per day)</label>
                <input type="number" id="food-cost" placeholder="e.g., 1000" value="0">
            </div>
            <div class="input-group">
                <label for="misc-cost">Miscellaneous (per day)</label>
                <input type="number" id="misc-cost" placeholder="e.g., 500" value="0">
            </div>
            <hr>

            <div class="input-group">
                <label for="round-trip" style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
                    <input type="checkbox" id="round-trip">
                    <span>Calculate Round Trip</span>
                </label>
            </div>

            <button id="calculate-trip">Calculate Trip</button>
            <button id="export-pdf-btn">Export as PDF</button>

            <div class="loader" id="loader">
                <p>Calculating...</p>
            </div>

            <div id="results">
                <h2>Trip Details</h2>
                <p id="origin-weather" class="weather-info"></p>
                <p id="destination-weather" class="weather-info"></p>
                <p id="total-distance"></p>
                <p id="total-duration"></p>
                <p id="time-calculation-result"></p>
                
                <div id="vehicle1-results" class="vehicle-results-section">
                    <h3>Vehicle 1 Cost Breakdown</h3>
                    <p id="fuel-cost1"></p>
                    <p id="round-trip-distance1" style="display: none;"></p>
                    <p id="round-trip-fuel-cost1" style="display: none;"></p>
                    <p id="total-trip-cost1" class="total-cost"></p>
                </div>

                <div id="vehicle2-results" class="vehicle-results-section" style="display: none;">
                    <h3>Vehicle 2 Cost Breakdown</h3>
                    <p id="fuel-cost2"></p>
                    <p id="round-trip-distance2" style="display: none;"></p>
                    <p id="round-trip-fuel-cost2" style="display: none;"></p>
                    <p id="total-trip-cost2" class="total-cost"></p>
                </div>

                <p id="error-message" class="error"></p>
            </div>
        </div>
        
        <!-- Recent Searches Tab Content -->
        <div id="recent" class="tab-content">
            <h3>Your Recent Searches</h3>
            <div id="recent-searches-list">
                <!-- Recent searches will be dynamically populated here -->
                <p>No recent searches found.</p>
            </div>
        </div>

    </div>
    <div id="map"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        // --- Hardcoded Firebase and App Config for Testing ---
        const appId = 'trip-planner-app-12345'; // Example App ID
        const firebaseConfig = {
            apiKey: "AIzaSyA1234567890abcdefghijklmnopqrstuvwxyz", // Replace with your actual Firebase API key
            authDomain: "your-project-id.firebaseapp.com", // Replace with your actual auth domain
            projectId: "your-project-id", // Replace with your actual project ID
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890"
        };
        
        // Import statements for Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Initialize Firebase
        setLogLevel('debug');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserId = null;

        // --- Firebase Authentication ---
        onAuthStateChanged(auth, user => {
            if (user) {
                console.log("User is signed in with UID:", user.uid);
                currentUserId = user.uid;
                fetchRecentSearches(); // Fetch searches once the user is authenticated
            } else {
                console.log("User is signed out.");
                currentUserId = null;
            }
        });

        // Sign in the user
        async function signInUser() {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Error signing in:", error);
                showError("Could not connect to the database. Please refresh.");
            }
        }
        
        // Call the sign-in function on script load
        signInUser();

        // --- Firestore Functions ---
        /**
         * Saves a trip search to the Firestore database.
         * @param {string} origin - The starting point of the trip.
         * @param {string} destination - The end point of the trip.
         * @param {string[]} stops - An array of intermediate stops.
         * @param {string} ipAddress - The user's IP address.
         */
        async function saveSearchToDb(origin, destination, stops, ipAddress) {
            if (!currentUserId) {
                console.error("Cannot save search: User not authenticated.");
                return;
            }
            try {
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/searches`), {
                    userId: currentUserId,
                    ipAddress: ipAddress, // Save the IP address
                    origin: origin,
                    destination: destination,
                    stops: stops,
                    timestamp: serverTimestamp()
                });
                console.log("Document written with ID: ", docRef.id);
                fetchRecentSearches(); // Refresh the list after saving
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }

        /**
         * Fetches the 10 most recent searches for the current user from Firestore.
         */
        async function fetchRecentSearches() {
            if (!currentUserId) return;

            const recentSearchesList = document.getElementById('recent-searches-list');
            recentSearchesList.innerHTML = '<p>Loading recent searches...</p>';

            try {
                const q = query(
                    collection(db, `artifacts/${appId}/public/searches`),
                    where("userId", "==", currentUserId),
                    orderBy("timestamp", "desc"),
                    limit(10)
                );

                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    recentSearchesList.innerHTML = '<p>No recent searches found.</p>';
                    return;
                }
                
                recentSearchesList.innerHTML = ''; // Clear the list
                querySnapshot.forEach((doc) => {
                    const search = doc.data();
                    const searchItem = document.createElement('div');
                    searchItem.className = 'recent-search-item';
                    
                    let stopsText = 'No stops';
                    if (search.stops && search.stops.length > 0) {
                        stopsText = `Via: ${search.stops.join(', ')}`;
                    }

                    // Handle display for "current location" lookups which have no destination
                    const routeText = search.destination 
                        ? `${search.origin} ‚Üí ${search.destination}`
                        : `üìç Current Location: ${search.origin}`;

                    searchItem.innerHTML = `
                        <p class="route">${routeText}</p>
                        <p class="stops">${stopsText}</p>
                    `;
                    
                    // Add click listener to populate the form with this search data
                    searchItem.addEventListener('click', () => {
                        populateFormFromSearch(search);
                    });

                    recentSearchesList.appendChild(searchItem);
                });
            } catch (error) {
                console.error("Error fetching recent searches:", error);
                recentSearchesList.innerHTML = '<p>Could not load recent searches.</p>';
            }
        }

        // Make functions globally accessible for inline event handlers
        window.fetchRecentSearches = fetchRecentSearches;
        window.saveSearchToDb = saveSearchToDb;

    </script>
    
    <script>
        // --- API KEY & MODEL ---
        const GEMINI_API_KEY = "AIzaSyC40CqEkqLPWjbBZIhZHLjZ3M093OmHyHg"; // Use the key you provided
        const GEMINI_MODEL = "gemini-2.5-flash";

        // Initialize Leaflet map
        const map = L.map('map').setView([8.5241, 76.9366], 12); // Default center (Thiruvananthapuram)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map); 

        // Get DOM elements
        const originInput = document.getElementById('origin');
        const useCurrentLocationBtn = document.getElementById('use-current-location-btn');
        const destinationInput = document.getElementById('destination');
        const stopsContainer = document.getElementById('stops-container');
        const addStopBtn = document.getElementById('add-stop-btn');
        const calculateBtn = document.getElementById('calculate-trip');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const resultsDiv = document.getElementById('results');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const startTimeInput = document.getElementById('start-time');
        const endTimeInput = document.getElementById('end-time');
        
        const mileageInput1 = document.getElementById('mileage1');
        const fuelTypeDropdown1 = document.getElementById('fuel-type1');
        const fuelPriceDisplay1 = document.getElementById('current-fuel-price-display1');
        
        const addVehicle2Checkbox = document.getElementById('add-vehicle2-checkbox');
        const vehicle2ProfileContainer = document.getElementById('vehicle2-profile-container');
        const mileageInput2 = document.getElementById('mileage2');
        const fuelTypeDropdown2 = document.getElementById('fuel-type2');
        const fuelPriceDisplay2 = document.getElementById('current-fuel-price-display2');

        const themeSwitch = document.getElementById('theme-switch');

        let stopCount = 0;
        let fuelPrices = { petrol: null, diesel: null };

        // --- Event Listeners ---
        window.addEventListener('load', () => {
            fetchAndDisplayFuelPrices();
            applySavedTheme();
        });

        useCurrentLocationBtn.addEventListener('click', handleGetCurrentLocation);
        startTimeInput.addEventListener('input', () => {
            if (startTimeInput.value) {
                endTimeInput.value = '';
                endTimeInput.disabled = true;
            } else {
                endTimeInput.disabled = false;
            }
        });
        endTimeInput.addEventListener('input', () => {
            if (endTimeInput.value) {
                startTimeInput.value = '';
                startTimeInput.disabled = true;
            } else {
                startTimeInput.disabled = false;
            }
        });
        addStopBtn.addEventListener('click', () => addStopInput());
        fuelTypeDropdown1.addEventListener('change', () => updateDisplayedFuelPrice(1));
        fuelTypeDropdown2.addEventListener('change', () => updateDisplayedFuelPrice(2));
        calculateBtn.addEventListener('click', calculateTrip);
        exportPdfBtn.addEventListener('click', exportResultsToPdf);
        themeSwitch.addEventListener('change', toggleTheme);
        addVehicle2Checkbox.addEventListener('change', toggleVehicle2Display);

        // --- Helper Functions ---
        /**
         * Fetches the user's public IP address.
         * @returns {Promise<string|null>} The IP address or null if an error occurs.
         */
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                if (!response.ok) return null;
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error("Could not fetch IP address:", error);
                return null;
            }
        }

        // --- UI Functions ---
        function openTab(tabName) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');

            if (tabName === 'recent') {
                window.fetchRecentSearches();
            }
        }

        function addStopInput(value = '') {
            stopCount++;
            const stopDiv = document.createElement('div');
            stopDiv.className = 'input-group';
            stopDiv.innerHTML = `
                <label for="stop-${stopCount}">Stop ${stopCount}</label>
                <input type="text" id="stop-${stopCount}" class="stop-input" placeholder="Add an intermediate stop" value="${value}">
            `;
            stopsContainer.appendChild(stopDiv);
        }

        function populateFormFromSearch(searchData) {
            originInput.value = searchData.origin;
            destinationInput.value = searchData.destination || ''; // Handle null destination
            
            stopsContainer.innerHTML = '';
            stopCount = 0;

            if (searchData.stops && searchData.stops.length > 0) {
                searchData.stops.forEach(stopValue => {
                    addStopInput(stopValue);
                });
            }
            
            openTab('planner');
        }

        async function handleGetCurrentLocation() {
            if (navigator.geolocation) {
                originInput.value = "";
                originInput.placeholder = "Fetching your location...";
                originInput.disabled = true;
                useCurrentLocationBtn.disabled = true;
                useCurrentLocationBtn.textContent = "Fetching...";

                const ipAddress = await getUserIP(); // Get IP first

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude } = position.coords;
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`);
                            if (!response.ok) throw new Error('Reverse geocoding request failed.');
                            const data = await response.json();
                            const city = data.address.city || data.address.town || data.address.village || '';
                            const state = data.address.state || '';
                            const address = [city, state].filter(Boolean).join(', ');
                            const finalAddress = address || `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
                            
                            originInput.value = finalAddress;
                            // Save the current location lookup to the database
                            window.saveSearchToDb(finalAddress, null, [], ipAddress);

                        } catch (error) {
                            console.error("Error fetching address:", error);
                            showError("Could not fetch address. Please enter manually.");
                            originInput.placeholder = "e.g., Ernakulam";
                        } finally {
                            originInput.disabled = false;
                            useCurrentLocationBtn.disabled = false;
                            useCurrentLocationBtn.innerHTML = "üìç Use My Location";
                        }
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        let message = "Could not get your location. ";
                        switch (error.code) {
                            case error.PERMISSION_DENIED: message += "Please allow location access."; break;
                            case error.POSITION_UNAVAILABLE: message += "Location information is unavailable."; break;
                            case error.TIMEOUT: message += "Request timed out."; break;
                            default: message += "An unknown error occurred."; break;
                        }
                        showError(message);
                        originInput.placeholder = "e.g., Ernakulam";
                        originInput.disabled = false;
                        useCurrentLocationBtn.disabled = false;
                        useCurrentLocationBtn.innerHTML = "üìç Use My Location";
                    }
                );
            } else {
                showError("Geolocation is not supported by your browser.");
            }
        }

        function applySavedTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                themeSwitch.checked = true;
            }
        }

        function toggleTheme() {
            if (themeSwitch.checked) {
                document.body.classList.add('dark-theme');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-theme');
                localStorage.setItem('theme', 'light');
            }
        }

        function toggleVehicle2Display() {
            if (addVehicle2Checkbox.checked) {
                vehicle2ProfileContainer.style.display = 'block';
                document.getElementById('vehicle2-results').style.display = 'block';
            } else {
                vehicle2ProfileContainer.style.display = 'none';
                document.getElementById('vehicle2-results').style.display = 'none';
                mileageInput2.value = '';
                fuelTypeDropdown2.value = 'petrol';
            }
        }

        async function fetchAndDisplayFuelPrices() {
            if (!GEMINI_API_KEY) {
                showError("Please add your Gemini API key to the script.");
                return;
            }
            const prompt = `Provide the current fuel prices for petrol and diesel in Thiruvananthapuram, Kerala, India today. The response should be a JSON object with the prices in Indian Rupees (‚Çπ) per liter.`;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: { type: "OBJECT", properties: { "petrol_price": { "type": "NUMBER" }, "diesel_price": { "type": "NUMBER" } }, required: ["petrol_price", "diesel_price"] }
                }
            };
            try {
                fuelPriceDisplay1.textContent = "Fetching...";
                fuelPriceDisplay2.textContent = "Fetching...";
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("Received an empty response from the API.");
                const prices = JSON.parse(text);
                if (prices.petrol_price && prices.diesel_price) {
                    fuelPrices.petrol = prices.petrol_price;
                    fuelPrices.diesel = prices.diesel_price;
                    updateDisplayedFuelPrice(1);
                    if (addVehicle2Checkbox.checked) updateDisplayedFuelPrice(2);
                } else {
                    throw new Error("Could not parse fuel prices from the API response.");
                }
            } catch (error) {
                console.error('Gemini API error:', error);
                const errorMsg = "Error fetching prices. Please try again later.";
                fuelPriceDisplay1.textContent = errorMsg;
                fuelPriceDisplay2.textContent = errorMsg;
            }
        }

        function updateDisplayedFuelPrice(vehicleId) {
            const fuelTypeDropdown = document.getElementById(`fuel-type${vehicleId}`);
            const fuelPriceDisplay = document.getElementById(`current-fuel-price-display${vehicleId}`);
            const selectedFuelType = fuelTypeDropdown.value;
            const price = fuelPrices[selectedFuelType];
            fuelPriceDisplay.textContent = price !== null ? `Current Price in Thiruvananthapuram: ‚Çπ${price.toFixed(2)} per liter` : "Price not available.";
        }
        
        async function calculateTrip() {
            clearResults();
            if (!GEMINI_API_KEY) {
                showError("Please add your Gemini API key to the script.");
                return;
            }
            if (fuelPrices.petrol === null || fuelPrices.diesel === null) {
                showError("Please wait for fuel prices to be fetched before calculating.");
                return;
            }
            loader.style.display = 'block';
            const origin = originInput.value;
            const destination = destinationInput.value;
            const stops = Array.from(document.querySelectorAll('.stop-input')).map(input => input.value).filter(val => val);
            if (!origin || !destination) {
                showError("Please enter an origin and a destination.");
                loader.style.display = 'none'; // Hide loader on validation failure
                return;
            }

            const ipAddress = await getUserIP();
            window.saveSearchToDb(origin, destination, stops, ipAddress);

            const originFull = `${origin}, Kerala, India`;
            const destinationFull = `${destination}, Kerala, India`;
            const stopsFull = stops.map(stop => `${stop}, Kerala, India`);
            let prompt = `Calculate the route for a car trip from "${originFull}" to "${destinationFull}"`;
            if (stopsFull.length > 0) {
                prompt = `Calculate the route for a car trip from "${originFull}" via "${stopsFull.join('" via "')}" to "${destinationFull}"`;
            }
            prompt += `. The trip must be entirely within India. Provide the total distance in kilometers, total duration in minutes, the current weather at the origin, and the current weather at the destination. For weather, include a short description and temperature in Celsius.`;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: { type: "OBJECT", properties: { "distance_km": { "type": "NUMBER" }, "duration_minutes": { "type": "NUMBER" }, "origin_weather": { "type": "OBJECT", "properties": { "description": { "type": "STRING" }, "temperature_celsius": { "type": "NUMBER" } } }, "destination_weather": { "type": "OBJECT", "properties": { "description": { "type": "STRING" }, "temperature_celsius": { "type": "NUMBER" } } } }, required: ["distance_km", "duration_minutes", "origin_weather", "destination_weather"] }
                }
            };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API request failed with status ${response.status}`);
                }
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("Received an empty response from the API.");
                const result = JSON.parse(text);
                const { distance_km, duration_minutes, origin_weather, destination_weather } = result;
                if (distance_km == null || duration_minutes == null) throw new Error("Could not get distance or duration from the API.");
                if (!origin_weather || !destination_weather) throw new Error("Could not get weather information.");
                displayResults(distance_km, duration_minutes * 60, origin_weather, destination_weather);
            } catch (error) {
                console.error('Gemini API error:', error);
                showError(error.message || "An unexpected error occurred.");
            } finally {
                loader.style.display = 'none';
            }
        }

        function displayResults(distanceInKm, durationInSeconds, originWeather, destinationWeather) {
            const isRoundTrip = document.getElementById('round-trip').checked;
            const originEmoji = getWeatherEmoji(originWeather.description);
            document.getElementById('origin-weather').innerHTML = `Origin Weather: ${originEmoji} ${originWeather.description}, ${originWeather.temperature_celsius.toFixed(1)}¬∞C`;
            const destEmoji = getWeatherEmoji(destinationWeather.description);
            document.getElementById('destination-weather').innerHTML = `Destination Weather: ${destEmoji} ${destinationWeather.description}, ${destinationWeather.temperature_celsius.toFixed(1)}¬∞C`;
            document.getElementById('total-distance').textContent = `One-Way Distance: ${distanceInKm.toFixed(2)} km`;
            document.getElementById('total-duration').textContent = `Estimated One-Way Duration: ${formatDuration(durationInSeconds)}`;
            const startTimeValue = startTimeInput.value;
            const endTimeValue = endTimeInput.value;
            const todayStr = new Date().toISOString().slice(0, 10);
            if (startTimeValue) {
                const startDateTime = new Date(`${todayStr}T${startTimeValue}`);
                const arrivalDateTime = new Date(startDateTime.getTime() + durationInSeconds * 1000);
                document.getElementById('time-calculation-result').textContent = `Estimated Arrival: ${arrivalDateTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true })}`;
            } else if (endTimeValue) {
                const endDateTime = new Date(`${todayStr}T${endTimeValue}`);
                const requiredStartDateTime = new Date(endDateTime.getTime() - durationInSeconds * 1000);
                document.getElementById('time-calculation-result').textContent = `Required Start: ${requiredStartDateTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true })}`;
            }
            displayVehicleResults(1, distanceInKm, isRoundTrip);
            if (addVehicle2Checkbox.checked) {
                const mileage2 = parseFloat(mileageInput2.value);
                if (!isNaN(mileage2) && mileage2 > 0) {
                    document.getElementById('vehicle2-results').style.display = 'block';
                    displayVehicleResults(2, distanceInKm, isRoundTrip);
                } else {
                    showError("Please enter a valid mileage for the second vehicle.");
                }
            } else {
                document.getElementById('vehicle2-results').style.display = 'none';
            }
        }

        function displayVehicleResults(vehicleId, distanceInKm, isRoundTrip) {
            const mileage = parseFloat(document.getElementById(`mileage${vehicleId}`).value);
            const fuelType = document.getElementById(`fuel-type${vehicleId}`).value;
            const fuelPrice = fuelPrices[fuelType];
            let oneWayCost = 0;
            if (mileage > 0 && fuelPrice > 0) {
                oneWayCost = (distanceInKm / mileage) * fuelPrice;
            }
            const hotelCost = parseFloat(document.getElementById('hotel-cost').value) || 0;
            const foodCost = parseFloat(document.getElementById('food-cost').value) || 0;
            const miscCost = parseFloat(document.getElementById('misc-cost').value) || 0;
            let totalCost = oneWayCost + hotelCost + foodCost + miscCost;
            document.getElementById(`fuel-cost${vehicleId}`).textContent = `Estimated One-Way Fuel Cost: ‚Çπ${oneWayCost.toFixed(2)}`;
            const roundTripDistElem = document.getElementById(`round-trip-distance${vehicleId}`);
            const roundTripFuelElem = document.getElementById(`round-trip-fuel-cost${vehicleId}`);
            roundTripDistElem.style.display = 'none';
            roundTripFuelElem.style.display = 'none';
            if (isRoundTrip) {
                const roundTripFuelCost = oneWayCost * 2;
                totalCost = roundTripFuelCost + hotelCost + (foodCost * 2) + (miscCost * 2);
                roundTripDistElem.textContent = `Round Trip Distance: ${(distanceInKm * 2).toFixed(2)} km`;
                roundTripFuelElem.textContent = `Round Trip Fuel Cost: ‚Çπ${roundTripFuelCost.toFixed(2)}`;
                roundTripDistElem.style.display = 'block';
                roundTripFuelElem.style.display = 'block';
            }
            document.getElementById(`total-trip-cost${vehicleId}`).textContent = `Total Estimated Trip Cost: ‚Çπ${totalCost.toFixed(2)}`;
        }

        function exportResultsToPdf() {
            const element = document.getElementById('results');
            if (element.children.length > 2) {
                html2pdf().from(element).set({ margin: 1, filename: 'trip_plan.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } }).save();
            } else {
                showError("Please calculate a trip before exporting to PDF.");
            }
        }

        function getWeatherEmoji(description) {
            const desc = description.toLowerCase();
            if (desc.includes('cloud') || desc.includes('overcast')) return '‚òÅÔ∏è';
            if (desc.includes('sun') || desc.includes('clear')) return '‚òÄÔ∏è';
            if (desc.includes('rain') || desc.includes('shower') || desc.includes('drizzle')) return 'üåßÔ∏è';
            if (desc.includes('storm') || desc.includes('thunder')) return '‚õàÔ∏è';
            if (desc.includes('snow')) return '‚ùÑÔ∏è';
            if (desc.includes('mist') || desc.includes('haze') || desc.includes('fog')) return 'üå´Ô∏è';
            return 'üåç';
        }

        function formatDuration(seconds) {
            if (seconds === 0) return 'N/A';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            let res = '';
            if (h > 0) res += `${h} hour${h > 1 ? 's' : ''} `;
            if (m > 0) res += `${m} minute${m > 1 ? 's' : ''}`;
            return res.trim() || 'Less than a minute';
        }

        function clearResults() {
            resultsDiv.querySelectorAll('p').forEach(p => p.textContent = '');
            errorMessage.textContent = '';
        }

        function showError(message) {
            loader.style.display = 'none';
            errorMessage.textContent = message;
        }
    </script>
</body>
</html>


