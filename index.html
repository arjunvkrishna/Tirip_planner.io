<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Planner</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        #sidebar {
            width: 380px;
            background: #f8f9fa;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #ddd;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        #map {
            flex: 1;
            background-color: #e9ecef;
        }
        h1 {
            font-size: 24px;
            margin-top: 0;
            text-align: center;
        }
        h3 {
            margin-bottom: 10px;
        }
       .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
        }
        input[type="text"], input[type="time"], input[type="number"], select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 15px;
        }
        input[type="checkbox"] {
            width: auto;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        input:disabled, select:disabled {
            background-color: #e9ecef;
            opacity: 0.7;
            cursor: not-allowed;
        }
        button {
            width: 100%;
            padding: 10px;
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }
        button:hover {
            background: linear-gradient(45deg, #0056b3, #003d80);
        }
        #add-stop-btn {
            background: #6c757d;
            margin-top: 10px;
        }
        #add-stop-btn:hover {
            background: #5a6268;
        }
        #results {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        #results h2 {
            margin-top: 0;
            text-align: center;
        }
        #results p {
            margin: 8px 0;
            font-size: 15px;
            background-color: #f0f2f5;
            padding: 10px;
            border-radius: 6px;
        }
       .time-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
       .time-option {
            flex: 1;
        }
       .error {
            color: #dc3545;
            font-weight: bold;
            margin-top: 15px;
            text-align: center;
            padding: 10px;
            background-color: rgba(220, 53, 69, 0.1);
            border-radius: 6px;
        }
       .loader {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .total-cost {
            font-weight: bold;
            color: #0056b3;
            font-size: 16px !important;
        }
        .weather-info {
            font-weight: 600;
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <h1>Trip Planner 🚗</h1>
        
        <div class="input-group">
            <label for="origin">Origin</label>
            <input type="text" id="origin" placeholder="e.g., Ernakulam">
        </div>

        <div id="stops-container">
        </div>
        <button id="add-stop-btn" type="button">Add Stop</button>

        <div class="input-group" style="margin-top: 15px;">
            <label for="destination">Destination</label>
            <input type="text" id="destination" placeholder="e.g., Munnar">
        </div>

        <div class="time-toggle">
            <div class="time-option">
                <label for="start-time">Start Time</label>
                <input type="time" id="start-time">
            </div>
            <div class="time-option">
                <label for="end-time">Arrival Time</label>
                <input type="time" id="end-time">
            </div>
        </div>
        
        <hr>
        <h3>Vehicle and Fuel Details (Thiruvananthapuram)</h3>
        <div class="input-group">
            <label for="mileage">Vehicle Mileage (km/L)</label>
            <input type="number" id="mileage" placeholder="e.g., 15" value="15">
        </div>
        
        <div class="input-group">
            <label for="fuel-type">Fuel Type</label>
            <select id="fuel-type">
                <option value="petrol">Petrol</option>
                <option value="diesel">Diesel</option>
            </select>
            <p id="current-fuel-price-display" style="margin-top: 10px; font-weight: bold;"></p>
        </div>
        
        <hr>
        <h3>Additional Expenses</h3>
        <div class="input-group">
            <label for="hotel-cost">Hotel Cost</label>
            <input type="number" id="hotel-cost" placeholder="e.g., 2500" value="0">
        </div>
        <div class="input-group">
            <label for="food-cost">Food Cost (per day)</label>
            <input type="number" id="food-cost" placeholder="e.g., 1000" value="0">
        </div>
        <div class="input-group">
            <label for="misc-cost">Miscellaneous (per day)</label>
            <input type="number" id="misc-cost" placeholder="e.g., 500" value="0">
        </div>
        <hr>

        <div class="input-group">
            <label for="round-trip" style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
                <input type="checkbox" id="round-trip">
                <span>Calculate Round Trip</span>
            </label>
        </div>

        <button id="calculate-trip">Calculate Trip</button>

        <div class="loader" id="loader">
            <p>Calculating...</p>
        </div>

        <div id="results">
            <h2>Trip Details</h2>
            <p id="origin-weather" class="weather-info"></p>
            <p id="destination-weather" class="weather-info"></p>
            <p id="total-distance"></p>
            <p id="total-duration"></p>
            <p id="time-calculation-result"></p>
            <p id="fuel-cost"></p>
            <p id="round-trip-distance"></p>
            <p id="round-trip-fuel-cost"></p>
            <p id="total-trip-cost" class="total-cost"></p>
            <p id="error-message" class="error"></p>
        </div>
    </div>
    <div id="map"></div>

    <script>
        // --- API KEY & MODEL ---
        const GEMINI_API_KEY = "AIzaSyAEI4iMpOqIsfbSpY9lYlOKAgixUQXQ6ps"; 
        const GEMINI_MODEL = "gemini-2.5-flash-preview-05-20";

        // Initialize Leaflet map
        const map = L.map('map').setView([8.5241, 76.9366], 12); // Default center (Thiruvananthapuram)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map); 

        // Get DOM elements
        const originInput = document.getElementById('origin');
        const destinationInput = document.getElementById('destination');
        const stopsContainer = document.getElementById('stops-container');
        const addStopBtn = document.getElementById('add-stop-btn');
        const calculateBtn = document.getElementById('calculate-trip');
        const resultsDiv = document.getElementById('results');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const startTimeInput = document.getElementById('start-time');
        const endTimeInput = document.getElementById('end-time');
        const fuelTypeDropdown = document.getElementById('fuel-type');
        const fuelPriceDisplay = document.getElementById('current-fuel-price-display');

        let stopCount = 0;
        let fuelPrices = {
            petrol: null,
            diesel: null
        };

        // Event listeners
        window.addEventListener('load', fetchAndDisplayFuelPrices);

        startTimeInput.addEventListener('input', () => {
            if (startTimeInput.value) {
                endTimeInput.value = '';
                endTimeInput.disabled = true;
            } else {
                endTimeInput.disabled = false;
            }
        });

        endTimeInput.addEventListener('input', () => {
            if (endTimeInput.value) {
                startTimeInput.value = '';
                startTimeInput.disabled = true;
            } else {
                startTimeInput.disabled = false;
            }
        });

        addStopBtn.addEventListener('click', () => {
            stopCount++;
            const stopDiv = document.createElement('div');
            stopDiv.className = 'input-group';
            stopDiv.innerHTML = `
                <label for="stop-${stopCount}">Stop ${stopCount}</label>
                <input type="text" id="stop-${stopCount}" class="stop-input" placeholder="Add an intermediate stop">
            `;
            stopsContainer.appendChild(stopDiv);
        });
        
        // Add event listener for fuel type dropdown to update the displayed price
        fuelTypeDropdown.addEventListener('change', () => {
            updateDisplayedFuelPrice();
        });

        calculateBtn.addEventListener('click', calculateTrip);

        /**
         * Fetches current fuel prices for Petrol and Diesel in Thiruvananthapuram using the Gemini API.
         * The prices are stored in a global object and the display is updated.
         */
        async function fetchAndDisplayFuelPrices() {
            if (!GEMINI_API_KEY) {
                showError("Please add your Gemini API key to the script.");
                return;
            }

            const prompt = `Provide the current fuel prices for petrol and diesel in Thiruvananthapuram, Kerala, India today. The response should be a JSON object with the prices in Indian Rupees (₹) per liter.`;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "petrol_price": { "type": "NUMBER" },
                            "diesel_price": { "type": "NUMBER" }
                        },
                        required: ["petrol_price", "diesel_price"]
                    }
                }
            };
            
            try {
                // Show a loading message for the fuel price fetch
                fuelPriceDisplay.textContent = "Fetching current fuel prices...";
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!text) {
                    throw new Error("Received an empty response from the API.");
                }
                
                const prices = JSON.parse(text);
                
                if (prices.petrol_price && prices.diesel_price) {
                    fuelPrices.petrol = prices.petrol_price;
                    fuelPrices.diesel = prices.diesel_price;
                    updateDisplayedFuelPrice();
                } else {
                    throw new Error("Could not parse fuel prices from the API response.");
                }
            } catch (error) {
                console.error('Gemini API error:', error);
                fuelPriceDisplay.textContent = "Error fetching prices. Please try again later.";
            }
        }

        /**
         * Updates the displayed fuel price in the UI based on the selected fuel type.
         */
        function updateDisplayedFuelPrice() {
            const selectedFuelType = fuelTypeDropdown.value;
            const price = fuelPrices[selectedFuelType];
            if (price !== null) {
                fuelPriceDisplay.textContent = `Current Price in Thiruvananthapuram: ₹${price.toFixed(2)} per liter`;
            } else {
                fuelPriceDisplay.textContent = "Price not available.";
            }
        }
        
        /**
         * Main function to calculate the trip details by calling the Gemini API.
         */
        async function calculateTrip() {
            clearResults();

            if (!GEMINI_API_KEY) {
                showError("Please add your Gemini API key to the script.");
                return;
            }
            
            // Check if fuel prices have been fetched
            if (fuelPrices.petrol === null || fuelPrices.diesel === null) {
                showError("Please wait for fuel prices to be fetched before calculating.");
                return;
            }

            loader.style.display = 'block';

            const origin = originInput.value;
            const destination = destinationInput.value;
            const stops = Array.from(document.querySelectorAll('.stop-input'))
                                     .map(input => input.value)
                                     .filter(val => val);

            if (!origin || !destination) {
                showError("Please enter an origin and a destination.");
                return;
            }

            // Append ", Kerala, India" to all location inputs for geographic accuracy.
            const originFull = `${origin}, Kerala, India`;
            const destinationFull = `${destination}, Kerala, India`;
            const stopsFull = stops.map(stop => `${stop}, Kerala, India`);

            let prompt = `Calculate the route for a car trip from "${originFull}" to "${destinationFull}"`;
            if (stopsFull.length > 0) {
                const stopsString = stopsFull.join('" via "');
                prompt = `Calculate the route for a car trip from "${originFull}" via "${stopsString}" to "${destinationFull}"`;
            }
            prompt += `. The trip must be entirely within India. Provide the total distance in kilometers, total duration in minutes, the current weather at the origin, and the current weather at the destination. For weather, include a short description and temperature in Celsius.`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "distance_km": { "type": "NUMBER" },
                            "duration_minutes": { "type": "NUMBER" },
                            "origin_weather": {
                                "type": "OBJECT",
                                "properties": {
                                    "description": { "type": "STRING" },
                                    "temperature_celsius": { "type": "NUMBER" }
                                }
                            },
                            "destination_weather": {
                                "type": "OBJECT",
                                "properties": {
                                    "description": { "type": "STRING" },
                                    "temperature_celsius": { "type": "NUMBER" }
                                }
                            }
                        },
                        required: ["distance_km", "duration_minutes", "origin_weather", "destination_weather"]
                    }
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API request failed with status ${response.status}`);
                }

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!text) {
                    throw new Error("Received an empty response from the API.");
                }

                const result = JSON.parse(text);
                const distanceInKm = result.distance_km;
                const durationInSeconds = result.duration_minutes * 60;
                const originWeather = result.origin_weather;
                const destinationWeather = result.destination_weather;

                if (distanceInKm === null || typeof distanceInKm === 'undefined' || durationInSeconds === null || typeof durationInSeconds === 'undefined') {
                    throw new Error("Could not get distance or duration from the API's JSON response.");
                }

                if (!originWeather || !destinationWeather) {
                    throw new Error("Could not get weather information from the API response.");
                }

                displayResults(distanceInKm, durationInSeconds, originWeather, destinationWeather);

            } catch (error) {
                console.error('Gemini API error:', error);
                showError(error.message || "An unexpected error occurred while calculating the trip.");
            } finally {
                loader.style.display = 'none';
            }
        }

        /**
         * Displays the calculated results in the sidebar.
         * @param {number} distanceInKm - Total distance of the trip.
         * @param {number} durationInSeconds - Total duration of the trip.
         * @param {object} originWeather - Weather data for the origin.
         * @param {object} destinationWeather - Weather data for the destination.
         */
        function displayResults(distanceInKm, durationInSeconds, originWeather, destinationWeather) {
            const roundTripCheckbox = document.getElementById('round-trip');
            const isRoundTrip = roundTripCheckbox.checked;

            // Display Weather
            const originEmoji = getWeatherEmoji(originWeather.description);
            document.getElementById('origin-weather').innerHTML = `Origin Weather: ${originEmoji} ${originWeather.description}, ${originWeather.temperature_celsius.toFixed(1)}°C`;
            
            const destEmoji = getWeatherEmoji(destinationWeather.description);
            document.getElementById('destination-weather').innerHTML = `Destination Weather: ${destEmoji} ${destinationWeather.description}, ${destinationWeather.temperature_celsius.toFixed(1)}°C`;

            // Display one-way trip details
            document.getElementById('total-distance').textContent = `One-Way Distance: ${distanceInKm.toFixed(2)} km`;
            document.getElementById('total-duration').textContent = `Estimated One-Way Duration: ${formatDuration(durationInSeconds)}`;

            // Calculate and display arrival/start time
            const startTimeValue = startTimeInput.value;
            const endTimeValue = endTimeInput.value;
            const todayStr = new Date().toISOString().slice(0, 10);

            if (startTimeValue) {
                const startDateTime = new Date(`${todayStr}T${startTimeValue}`);
                const arrivalDateTime = new Date(startDateTime.getTime() + durationInSeconds * 1000);
                document.getElementById('time-calculation-result').textContent = `Estimated Arrival: ${arrivalDateTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true })}`;
            } else if (endTimeValue) {
                const endDateTime = new Date(`${todayStr}T${endTimeValue}`);
                const requiredStartDateTime = new Date(endDateTime.getTime() - durationInSeconds * 1000);
                document.getElementById('time-calculation-result').textContent = `Required Start: ${requiredStartDateTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true })}`;
            }

            // Calculate costs using the fetched fuel price
            const mileage = parseFloat(document.getElementById('mileage').value);
            const selectedFuelType = fuelTypeDropdown.value;
            const fuelPrice = fuelPrices[selectedFuelType];

            let oneWayCost = 0;

            if (mileage > 0 && fuelPrice > 0) {
                const oneWayFuelNeeded = distanceInKm / mileage;
                oneWayCost = oneWayFuelNeeded * fuelPrice;
                document.getElementById('fuel-cost').textContent = `Estimated One-Way Fuel Cost (${selectedFuelType}): ₹${oneWayCost.toFixed(2)}`;
            }
            
            const hotelCost = parseFloat(document.getElementById('hotel-cost').value) || 0;
            const foodCost = parseFloat(document.getElementById('food-cost').value) || 0;
            const miscCost = parseFloat(document.getElementById('misc-cost').value) || 0;

            let totalCost = oneWayCost + hotelCost + foodCost + miscCost;

            // If round trip is checked, calculate and display round trip details
            if (isRoundTrip) {
                const roundTripDistance = distanceInKm * 2;
                const roundTripFuelCost = oneWayCost * 2;
                totalCost = roundTripFuelCost + hotelCost + (foodCost * 2) + (miscCost * 2);

                document.getElementById('round-trip-distance').textContent = `Round Trip Distance: ${roundTripDistance.toFixed(2)} km`;
                document.getElementById('round-trip-fuel-cost').textContent = `Round Trip Fuel Cost: ₹${roundTripFuelCost.toFixed(2)}`;
            }

            document.getElementById('total-trip-cost').textContent = `Total Estimated Trip Cost: ₹${totalCost.toFixed(2)}`;
        }

        /**
         * Selects a weather emoji based on the weather description.
         * @param {string} description - The weather description text.
         * @returns {string} An emoji character.
         */
        function getWeatherEmoji(description) {
            const desc = description.toLowerCase();
            if (desc.includes('cloud') || desc.includes('overcast')) return '☁️';
            if (desc.includes('sun') || desc.includes('clear')) return '☀️';
            if (desc.includes('rain') || desc.includes('shower') || desc.includes('drizzle')) return '🌧️';
            if (desc.includes('storm') || desc.includes('thunder')) return '⛈️';
            if (desc.includes('snow')) return '❄️';
            if (desc.includes('mist') || desc.includes('haze') || desc.includes('fog')) return '🌫️';
            return '🌍'; // default
        }

        /**
         * Formats a duration in seconds into a human-readable string (e.g., "1 hour 30 minutes").
         * @param {number} seconds - The duration in seconds.
         * @returns {string} The formatted duration string.
         */
        function formatDuration(seconds) {
            if (seconds === 0) return 'N/A';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            let result = '';
            if (hours > 0) result += `${hours} hour${hours > 1 ? 's' : ''} `;
            if (minutes > 0) result += `${minutes} minute${minutes > 1 ? 's' : ''}`;
            if (result === '') result = 'Less than a minute';
            return result.trim();
        }

        /**
         * Clears all previous results and error messages from the UI.
         */
        function clearResults() {
            resultsDiv.querySelectorAll('p').forEach(p => p.textContent = '');
            errorMessage.textContent = '';
        }

        /**
         * Displays an error message in the UI.
         * @param {string} message - The error message to display.
         */
        function showError(message) {
            loader.style.display = 'none';
            errorMessage.textContent = message;
        }

    </script>
</body>
</html>
