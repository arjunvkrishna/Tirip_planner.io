<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Planner</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #e9ecef;
            --border-color: #ddd;
            --button-primary: linear-gradient(45deg, #007bff, #0056b3);
            --button-secondary: #6c757d;
            --button-secondary-hover: #5a6268;
            --error-bg: rgba(220, 53, 69, 0.1);
            --total-cost-color: #0056b3;
            --toggle-bg: #ccc;
            --toggle-thumb: #f1f1f1;
            --toggle-checked-bg: #2196F3;
            --tab-active-bg: #007bff;
            --tab-inactive-bg: #e9ecef;
            --tab-active-color: #fff;
            --tab-inactive-color: #333;
        }

        .dark-theme {
            --bg-color: #2c3e50;
            --text-color: #f1f1f1;
            --card-bg: #34495e;
            --border-color: #444;
            --button-primary: linear-gradient(45deg, #1abc9c, #16a085);
            --button-secondary: #7f8c8d;
            --button-secondary-hover: #636e72;
            --error-bg: rgba(231, 76, 60, 0.2);
            --total-cost-color: #1abc9c;
            --toggle-bg: #555;
            --toggle-thumb: #f1f1f1;
            --toggle-checked-bg: #1abc9c;
            --tab-active-bg: #1abc9c;
            --tab-inactive-bg: #34495e;
            --tab-active-color: #fff;
            --tab-inactive-color: #f1f1f1;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        #sidebar {
            width: 380px;
            background: var(--bg-color);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        #map {
            flex: 1;
            background-color: var(--card-bg);
        }
        h1 {
            font-size: 24px;
            margin-top: 0;
            text-align: center;
        }
        h3 {
            margin-bottom: 10px;
        }
       .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
        }
        input[type="text"], input[type="time"], input[type="number"], select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 15px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        input[type="checkbox"] {
            width: auto;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        input:disabled, select:disabled {
            background-color: var(--card-bg);
            opacity: 0.7;
            cursor: not-allowed;
        }
        button {
            width: 100%;
            padding: 10px;
            background: var(--button-primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        button:hover {
            opacity: 0.9;
        }
        #add-stop-btn {
            background: var(--button-secondary);
            margin-top: 10px;
        }
        #add-stop-btn:hover {
            background: var(--button-secondary-hover);
        }
        #results {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        #results h2 {
            margin-top: 0;
            text-align: center;
        }
        #results p {
            margin: 8px 0;
            font-size: 15px;
            background-color: var(--card-bg);
            padding: 10px;
            border-radius: 6px;
        }
       .time-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
       .time-option {
            flex: 1;
        }
       .error {
            color: #dc3545;
            font-weight: bold;
            margin-top: 15px;
            text-align: center;
            padding: 10px;
            background-color: var(--error-bg);
            border-radius: 6px;
        }
       .loader {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .total-cost {
            font-weight: bold;
            color: var(--total-cost-color);
            font-size: 16px !important;
        }
        .weather-info {
            font-weight: 600;
        }
        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: 10px;
            gap: 10px;
        }
        .theme-toggle label {
            margin: 0;
            cursor: pointer;
        }
        .vehicle-profile {
            border: 1px solid var(--border-color);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: var(--card-bg);
        }
        .vehicle-profile h3 {
            margin-top: 0;
        }
        .add-vehicle-option {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        /* Toggle Switch Styling */
        .switch-label {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
            border-radius: 34px;
            background-color: var(--toggle-bg);
            cursor: pointer;
            transition: background-color 0.4s;
        }
        .switch-label::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--toggle-thumb);
            top: 2px;
            left: 2px;
            transition: transform 0.4s;
        }
        .theme-checkbox:checked + .switch-label {
            background-color: var(--toggle-checked-bg);
        }
        .theme-checkbox:checked + .switch-label::after {
            transform: translateX(22px);
        }
        .theme-checkbox {
            display: none;
        }
        /* New Styles for Tabs */
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .tab-button {
            flex: 1;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            border: none;
            background-color: var(--tab-inactive-bg);
            color: var(--tab-inactive-color);
            font-weight: 600;
            transition: background-color 0.3s, color 0.3s;
            border-radius: 4px 4px 0 0;
            margin-bottom: 0;
        }
        .tab-button.active {
            background: var(--tab-active-bg);
            color: var(--tab-active-color);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #recent-searches-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .recent-search-item {
            background-color: var(--card-bg);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .recent-search-item:hover {
            background-color: var(--border-color);
        }
        .recent-search-item p {
            margin: 0;
            font-size: 14px;
        }
        .recent-search-item .route {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .recent-search-item .stops {
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.8;
        }

    </style>
</head>
<body>

    <div id="sidebar">
        <div class="theme-toggle">
            <label>Dark Mode</label>
            <input type="checkbox" id="theme-switch" class="theme-checkbox">
            <label for="theme-switch" class="switch-label"></label>
        </div>
        <h1>Trip Planner 🚗</h1>

        <!-- Tabs Navigation -->
        <div class="tabs">
            <button class="tab-button active" onclick="openTab('planner')">Planner</button>
            <button class="tab-button" onclick="openTab('recent')">Recent Searches</button>
        </div>

        <!-- Planner Tab Content -->
        <div id="planner" class="tab-content active">
            <div class="input-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <label for="origin" style="margin-bottom: 0;">Origin</label>
                    <button id="use-current-location-btn" type="button" style="width: auto; padding: 5px 10px; font-size: 12px; font-weight: 500; background: var(--button-secondary); margin: 0;">📍 Use My Location</button>
                </div>
                <input type="text" id="origin" placeholder="e.g., Ernakulam">
            </div>

            <div id="stops-container"></div>
            <button id="add-stop-btn" type="button">Add Stop</button>

            <div class="input-group" style="margin-top: 15px;">
                <label for="destination">Destination</label>
                <input type="text" id="destination" placeholder="e.g., Munnar">
            </div>

            <div class="time-toggle">
                <div class="time-option">
                    <label for="start-time">Start Time</label>
                    <input type="time" id="start-time">
                </div>
                <div class="time-option">
                    <label for="end-time">Arrival Time</label>
                    <input type="time" id="end-time">
                </div>
            </div>
            
            <hr>
            
            <div class="vehicle-profile">
                <h3>Vehicle 1 Details</h3>
                <div class="input-group">
                    <label for="mileage1">Vehicle Mileage (km/L)</label>
                    <input type="number" id="mileage1" placeholder="e.g., 15" value="15">
                </div>
                <div class="input-group">
                    <label for="fuel-type1">Fuel Type</label>
                    <select id="fuel-type1">
                        <option value="petrol">Petrol</option>
                        <option value="diesel">Diesel</option>
                    </select>
                    <p id="current-fuel-price-display1" style="margin-top: 10px; font-weight: bold;"></p>
                </div>
            </div>
            
            <div class="add-vehicle-option">
                <label for="add-vehicle2-checkbox" style="font-weight: normal;">Add Second Vehicle</label>
                <input type="checkbox" id="add-vehicle2-checkbox">
            </div>

            <div id="vehicle2-profile-container" class="vehicle-profile" style="display: none;">
                <h3>Vehicle 2 Details</h3>
                <div class="input-group">
                    <label for="mileage2">Vehicle Mileage (km/L)</label>
                    <input type="number" id="mileage2" placeholder="e.g., 20">
                </div>
                <div class="input-group">
                    <label for="fuel-type2">Fuel Type</label>
                    <select id="fuel-type2">
                        <option value="petrol">Petrol</option>
                        <option value="diesel">Diesel</option>
                    </select>
                    <p id="current-fuel-price-display2" style="margin-top: 10px; font-weight: bold;"></p>
                </div>
            </div>
            
            <hr>
            <h3>Additional Expenses</h3>
            <div class="input-group">
                <label for="hotel-cost">Hotel Cost</label>
                <input type="number" id="hotel-cost" placeholder="e.g., 2500" value="0">
            </div>
            <div class="input-group">
                <label for="food-cost">Food Cost (per day)</label>
                <input type="number" id="food-cost" placeholder="e.g., 1000" value="0">
            </div>
            <div class="input-group">
                <label for="misc-cost">Miscellaneous (per day)</label>
                <input type="number" id="misc-cost" placeholder="e.g., 500" value="0">
            </div>
            <hr>

            <div class="input-group">
                <label for="round-trip" style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
                    <input type="checkbox" id="round-trip">
                    <span>Calculate Round Trip</span>
                </label>
            </div>

            <button id="calculate-trip">Calculate Trip</button>
            <button id="export-pdf-btn">Export as PDF</button>

            <div class="loader" id="loader">
                <p>Calculating...</p>
            </div>

            <div id="results">
                <h2>Trip Details</h2>
                <p id="origin-weather" class="weather-info"></p>
                <p id="destination-weather" class="weather-info"></p>
                <p id="total-distance"></p>
                <p id="total-duration"></p>
                <p id="time-calculation-result"></p>
                
                <div id="vehicle1-results" class="vehicle-results-section">
                    <h3>Vehicle 1 Cost Breakdown</h3>
                    <p id="fuel-cost1"></p>
                    <p id="round-trip-distance1" style="display: none;"></p>
                    <p id="round-trip-fuel-cost1" style="display: none;"></p>
                    <p id="total-trip-cost1" class="total-cost"></p>
                </div>

                <div id="vehicle2-results" class="vehicle-results-section" style="display: none;">
                    <h3>Vehicle 2 Cost Breakdown</h3>
                    <p id="fuel-cost2"></p>
                    <p id="round-trip-distance2" style="display: none;"></p>
                    <p id="round-trip-fuel-cost2" style="display: none;"></p>
                    <p id="total-trip-cost2" class="total-cost"></p>
                </div>

                <p id="error-message" class="error"></p>
            </div>
        </div>
        
        <!-- Recent Searches Tab Content -->
        <div id="recent" class="tab-content">
            <h3>Your Recent Searches</h3>
            <div id="recent-searches-list">
                <!-- Recent searches will be dynamically populated here -->
                <p>No recent searches found.</p>
            </div>
        </div>

    </div>
    <div id="map"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        // These variables are placeholders and will be provided by the environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "your-api-key", authDomain: "your-auth-domain", ...console.error("Firebase config not found") };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

        // Import statements for Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Initialize Firebase
        setLogLevel('debug');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserId = null;

        // --- Firebase Authentication ---
        onAuthStateChanged(auth, user => {
            if (user) {
                console.log("User is signed in with UID:", user.uid);
                currentUserId = user.uid;
                fetchRecentSearches(); // Fetch searches once the user is authenticated
            } else {
                console.log("User is signed out.");
                currentUserId = null;
            }
        });

        // Sign in the user
        async function signInUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error signing in:", error);
                showError("Could not connect to the database. Please refresh.");
            }
        }
        
        // Call the sign-in function on script load
        signInUser();

        // --- Firestore Functions ---
        /**
         * Saves a trip search to the Firestore database.
         * @param {string} origin - The starting point of the trip.
         * @param {string} destination - The end point of the trip.
         * @param {string[]} stops - An array of intermediate stops.
         * @param {string} ipAddress - The user's IP address.
         */
        async function saveSearchToDb(origin, destination, stops, ipAddress) {
            if (!currentUserId) {
                console.error("Cannot save search: User not authenticated.");
                return;
            }
            try {
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/searches`), {
                    userId: currentUserId,
                    ipAddress: ipAddress, // Save the IP address
                    origin: origin,
                    destination: destination,
                    stops: stops,
                    timestamp: serverTimestamp()
                });
                console.log("Document written with ID: ", docRef.id);
                fetchRecentSearches(); // Refresh the list after saving
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }

        /**
         * Fetches the 10 most recent searches for the current user from Firestore.
         */
        async function fetchRecentSearches() {
            if (!currentUserId) return;

            const recentSearchesList = document.getElementById('recent-searches-list');
            recentSearchesList.innerHTML = '<p>Loading recent searches...</p>';

            try {
                const q = query(
                    col